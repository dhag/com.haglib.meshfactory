// Assets/Editor/SimpleMeshFactory.GUI.Tools.cs
// ToolManager統合版
// Phase 1: UI描画をToolManagerと連携

using System.Collections.Generic;
using UnityEditor;
using UnityEngine;
using MeshFactory.Tools;
using MeshFactory.Selection;


public partial class SimpleMeshFactory
{
    // ================================================================
    // ツールボタンレイアウト定義
    // ================================================================

    /// <summary>
    /// ツールボタンの行定義
    /// 新しいツールを追加する場合はToolRegistryと併せてここも更新
    /// </summary>
    private static readonly string[][] ToolButtonLayout = new string[][]
    {
        new[] { "Select", "Move" },
        new[] { "AddFace", "Knife" },
        new[] { "EdgeTopo", "Sel+" },
        new[] { "Sculpt", "Merge" },
        new[] { "Extrude", "Push" },
        new[] { "Bevel", "Pivot" },
    };

    // ================================================================
    // Tools セクション描画
    // ================================================================

    private void DrawToolsSection()
    {
        _foldTools = EditorGUILayout.Foldout(_foldTools, "Tools", true);
        if (!_foldTools)
            return;

        EditorGUI.indentLevel++;

        // ツールボタン（レイアウト定義に基づいて描画）
        DrawToolButtons();

        // 現在のツールの設定UI
        EditorGUILayout.Space(3);

        // ツール設定UIの描画とUndo処理
        DrawCurrentToolSettingsWithUndo();

        // ツール設定をシリアライズ用に同期
        SyncSettingsFromTool();

        EditorGUI.indentLevel--;
    }

    /// <summary>
    /// ツールボタンを描画
    /// </summary>
    private void DrawToolButtons()
    {
        foreach (var row in ToolButtonLayout)
        {
            using (new EditorGUILayout.HorizontalScope())
            {
                foreach (var toolName in row)
                {
                    var tool = _toolManager?.GetTool(toolName);
                    if (tool != null)
                    {
                        string displayName = ToolRegistry.GetDisplayName(toolName);
                        DrawToolButton(tool, displayName);
                    }
                }
            }
        }
    }

    /// <summary>
    /// 個別ツールボタンを描画
    /// </summary>
    private void DrawToolButton(IEditTool tool, string label)
    {
        if (tool == null) return;

        bool isActive = _toolManager?.CurrentTool == tool;
        var oldColor = GUI.backgroundColor;
        if (isActive)
            GUI.backgroundColor = new Color(0.6f, 0.8f, 1f);

        if (GUILayout.Toggle(isActive, label, "Button") && !isActive)
        {
            // Undo記録付きでツール切り替え
            SwitchToolWithUndo(tool);
        }

        GUI.backgroundColor = oldColor;
    }

    private void SwitchToolWithUndo(IEditTool newTool)
    {
        if (_undoController != null)
        {
            string oldToolName = _toolManager?.CurrentToolName ?? "Select";
            _undoController.EditorState.CurrentToolName = oldToolName;
            _undoController.BeginEditorStateDrag();
        }

        _toolManager.SetTool(newTool);

        if (_undoController != null)
        {
            _undoController.EditorState.CurrentToolName = newTool.Name;
            _undoController.EndEditorStateDrag($"Switch to {newTool.Name} Tool");
        }
    }

    // ================================================================
    // ツール設定UI描画 + Undo処理
    // ================================================================

    /// <summary>
    /// 現在のツールの設定UIを描画し、変更があればUndo記録
    /// </summary>
    private void DrawCurrentToolSettingsWithUndo()
    {
        var currentTool = _toolManager?.CurrentTool;
        if (currentTool == null)
            return;

        // --------------------------------------------------------
        // KnifeTool: 既存の処理を維持（後方互換）
        // 将来的にKnifeSettingsに移行後、この分岐は削除可能
        // --------------------------------------------------------
        if (currentTool is KnifeTool knife)
        {
            DrawKnifeToolSettingsWithUndo(knife);
            return;
        }

        // --------------------------------------------------------
        // IToolSettings対応ツール: 汎用Undo処理
        // --------------------------------------------------------
        var settings = currentTool.Settings;
        if (settings != null)
        {
            // Before: スナップショット取得
            IToolSettings before = settings.Clone();

            // UI描画（ツール側で自由に実装）
            currentTool.DrawSettingsUI();

            // After: 変更検出 & Undo記録
            if (settings.IsDifferentFrom(before))
            {
                RecordToolSettingsChange(before, settings.Clone());
            }
        }
        else
        {
            // 設定を持たないツール（SelectToolなど）
            currentTool.DrawSettingsUI();
        }
    }

    /// <summary>
    /// ツール設定変更をUndo記録
    /// </summary>
    private void RecordToolSettingsChange(IToolSettings before, IToolSettings after)
    {
        if (_undoController == null || before == null || after == null)
            return;

        var editorState = _undoController.EditorState;
        if (editorState.ToolSettings == null)
            editorState.ToolSettings = new ToolSettingsStorage();

        // Before: 変更前の設定をEditorStateContextに設定
        editorState.ToolSettings.Set(before);

        // BeginDrag: スナップショット取得
        _undoController.BeginEditorStateDrag();

        // After: 変更後の設定をEditorStateContextに設定
        editorState.ToolSettings.Set(after);

        // EndDrag: 差異検出 & Undo記録
        _undoController.EndEditorStateDrag($"Change {after.ToolName} Settings");

        Repaint();
    }

    // ================================================================
    // KnifeTool専用処理（既存コード維持）
    // ================================================================

    /// <summary>
    /// KnifeToolの設定UIを描画（既存処理維持）
    /// </summary>
    private void DrawKnifeToolSettingsWithUndo(KnifeTool knifeTool)
    {
        // 変更前の状態を保存
        var oldMode = knifeTool.knifeProperty.Mode;
        var oldEdgeSelect = knifeTool.knifeProperty.EdgeSelect;
        var oldChainMode = knifeTool.knifeProperty.ChainMode;

        // UI描画
        knifeTool.DrawSettingsUI();

        // 設定が変更されたらUndo記録
        if (knifeTool.knifeProperty.Mode != oldMode ||
            knifeTool.knifeProperty.EdgeSelect != oldEdgeSelect ||
            knifeTool.knifeProperty.ChainMode != oldChainMode)
        {
            // 変更前の状態を復元（BeginDrag前に必要）
            _undoController.EditorState.knifeProperty.Mode = oldMode;
            _undoController.EditorState.knifeProperty.EdgeSelect = oldEdgeSelect;
            _undoController.EditorState.knifeProperty.ChainMode = oldChainMode;

            _undoController.BeginEditorStateDrag();

            // 変更後の状態を設定
            _undoController.EditorState.knifeProperty.Mode = knifeTool.knifeProperty.Mode;
            _undoController.EditorState.knifeProperty.EdgeSelect = knifeTool.knifeProperty.EdgeSelect;
            _undoController.EditorState.knifeProperty.ChainMode = knifeTool.knifeProperty.ChainMode;

            _undoController.EndEditorStateDrag("Change Knife Settings");
        }
    }
}
